---
- name: configure a vagrant base box
  hosts: test-vagrant-base-box

  vars:
    user:     "{{ lookup('env', 'ANSIBLE_PERSONAL_USER') }}"
    password: "{{ lookup('env', 'ANSIBLE_PERSONAL_PASSWORD') }}"
    key_file: "{{ lookup('env', 'ANSIBLE_PERSONAL_PUBKEYFILE') }}"

  tasks:
    - name: install some base packages
      apt:
        name: "{{ item }}"
        update_cache: yes
      with_items:
        - git
        - sudo
        - curl
      become: yes

    - name: "create {{ user }} user in box"
      user:
        name: "{{ user }}"
        password: "{{ password }}"
        comment: "{{ user }} only user, accessible through ssh with personal key"
        group: "{{ user }}"
        groups: adm,sudo
        append: yes
      become: yes

    - name: "set authorized key took from {{ user }}"
      authorized_key:
        user: "{{ user }}"
        state: present
        key: "{{ lookup('file', key_file) }}"

    - name: checkout dotfiles repository from my personal github account
      git:
        repo: "https://github.com/{{ user }}/dotfiles.git"
        dest: "{{ lookup('env', 'HOME') }}/dotfiles"

    - name: execute setup.sh from dotfiles repository
      command: "bash {{ lookup('env', 'HOME') }}/dotfiles/setup.sh"
      environment:
        DOTFILES_DIR: "{{ lookup('env', 'HOME') }}/dotfiles"
        DOTFILES_ENV: laptop

    - name: install goss to server (part 1)
      get_url:
        url: https://goss.rocks/install
        dest: /tmp/goss_install.sh

    - name: install goss to server (part 2)
      command: bash /tmp/goss_install.sh
      become: yes
  # roles:
  #   - role: docker
  #     tags: docker
